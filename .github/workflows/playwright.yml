name: Playwright CI - Staged Execution

on:
  pull_request:
    branches: [main, master]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: playwright-ci-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  BASE_URL: ${{ vars.BASE_URL }}
  APP_USER_STANDARD_USERNAME: ${{ vars.APP_USER_STANDARD_USERNAME }}
  APP_USER_STANDARD_PASSWORD: ${{ secrets.APP_USER_STANDARD_PASSWORD }}
  APP_USER_LOCKED_USERNAME: ${{ vars.APP_USER_LOCKED_USERNAME }}
  APP_USER_LOCKED_PASSWORD: ${{ secrets.APP_USER_LOCKED_PASSWORD }}
  APP_USER_INVALID_USERNAME: ${{ vars.APP_USER_INVALID_USERNAME }}
  APP_USER_INVALID_PASSWORD: ${{ secrets.APP_USER_INVALID_PASSWORD }}

jobs:
  auth-tests:
    name: Authentication Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Chromium
        run: npx playwright install --with-deps chromium

      - name: Run Authentication Tests with Retry
        run: npm run test:auth:retry -- --project=chromium --reporter=html,list

      - name: Upload auth artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: auth-test-results
          path: |
            playwright-report/
            test-results/
          retention-days: 14

  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: auth-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Chromium
        run: npx playwright install --with-deps chromium

      - name: Run Smoke Tests
        run: npm run test:smoke -- --project=chromium --retries=2 --reporter=html,list

      - name: Upload smoke artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-test-results
          path: |
            playwright-report/
            test-results/
          retention-days: 14

  regression-tests:
    name: Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: smoke-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Chromium
        run: npx playwright install --with-deps chromium

      - name: Run Regression Tests
        run: npm run test:regression -- --project=chromium --retries=2 --reporter=html,list

      - name: Upload regression artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: regression-test-results
          path: |
            playwright-report/
            test-results/
          retention-days: 14

  full-test-suite:
    name: Full Suite (Chromium)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [auth-tests, smoke-tests, regression-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Chromium
        run: npx playwright install --with-deps chromium

      - name: Run Full Test Suite on Chromium
        run: npx playwright test --project=chromium --retries=2 --reporter=html,list

      - name: Upload full-suite artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: full-suite-chromium-results
          path: |
            playwright-report/
            test-results/
          retention-days: 14

  auto-heal:
    name: Auto-Heal Snapshots
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: [auth-tests, smoke-tests, regression-tests, full-test-suite]
    if: >-
      always() &&
      github.event_name == 'pull_request' &&
      github.event.pull_request.head.repo.full_name == github.repository &&
      (needs.auth-tests.result == 'failure' ||
       needs.smoke-tests.result == 'failure' ||
       needs.regression-tests.result == 'failure' ||
       needs.full-test-suite.result == 'failure')

    steps:
      - name: Checkout PR head branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Chromium
        run: npx playwright install --with-deps chromium

      - name: Attempt snapshot healing
        run: npx playwright test --project=chromium --update-snapshots --retries=1 --reporter=list
        continue-on-error: true

      - name: Detect snapshot changes
        id: snapshot_diff
        run: |
          changed=$(git ls-files -mo --exclude-standard | grep -E "__snapshots__|\\.snap(\\.png)?$" | wc -l || true)
          echo "changed_snapshots=$changed" >> "$GITHUB_OUTPUT"

      - name: Commit and push healed snapshots to PR branch
        if: steps.snapshot_diff.outputs.changed_snapshots != '0'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No staged changes after add -A"
            exit 0
          fi
          git commit -m "chore(heal): update Playwright snapshots [auto-heal]"
          git push origin "HEAD:${{ github.head_ref }}"

      - name: Comment heal summary on PR
        if: steps.snapshot_diff.outputs.changed_snapshots != '0'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr comment "${{ github.event.pull_request.number }}" \
            --body "Auto-heal applied and pushed ${{ steps.snapshot_diff.outputs.changed_snapshots }} snapshot file(s) to branch ${{ github.head_ref }}."

  governance-gate:
    name: Governance Gate
    runs-on: ubuntu-latest
    needs: [auth-tests, smoke-tests, regression-tests, full-test-suite, auto-heal]
    if: always()
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run Governance Gate
        run: node ./scripts/ci/governance-gate.mjs governance-gate-report.md

      - name: Upload governance report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: governance-gate-report
          path: governance-gate-report.md
          retention-days: 14
